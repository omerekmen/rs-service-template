# Development Dockerfile for local testing with docker-compose
# Uses standard Debian-based images for simplicity and compatibility

# Stage 1: Builder
FROM rust:1.85-slim AS builder

# Install dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Accept build argument for service name (api, worker, grpc, cli)
ARG SERVICE_NAME=api
ENV SERVICE_NAME=${SERVICE_NAME}

# Copy workspace manifests first for better layer caching
COPY Cargo.toml Cargo.lock ./

# Copy all crates and services
COPY crates/ ./crates/
COPY services/ ./services/

# Copy configuration files and migrations
COPY config/ ./config/
COPY crates/infrastructure/migrations/ ./migrations/

# Build the specified service in release mode
# Using default target (not musl) for faster local builds
RUN cargo build --release -p ${SERVICE_NAME} && \
    cp /app/target/release/${SERVICE_NAME} /output-binary

# Stage 2: Runtime
FROM debian:12-slim

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    libssl3 \
    && rm -rf /var/lib/apt/lists/*

# Create app user
RUN useradd -m -u 1000 app

# Create app directory
WORKDIR /app

# Copy binary from builder
COPY --from=builder /output-binary /app/service

# Copy configuration files
COPY --from=builder /app/config /app/config

# Copy migrations
COPY --from=builder /app/migrations /app/migrations

# Change ownership
RUN chown -R app:app /app

# Switch to app user
USER app

# Expose default port
EXPOSE 8080

# Run the service binary
ENTRYPOINT ["/app/service"]
